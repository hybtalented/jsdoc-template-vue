const MFS = require('memory-fs');

module.exports = class ServerPlugin {
  constructor(updateFn, readFileFn) {
    this.updateFn = updateFn;
    this.readFileFn = readFileFn;
    this.mfs = new MFS();
  }

  /**
   * @summary 执行插件
   * @param {webpack.Compiler} complier
   */
  apply(compiler) {
    compiler.outputFileSystem = this.mfs;
    compiler.hooks.done.tap(compiler_stats => {
      const stats = compiler_stats.toJson();
      if (stats.errors.length) return;

      // read bundle generated by vue-ssr-webpack-plugin
      const bundle = JSON.parse(this.readFileFn(this.mfs, 'vue-ssr-server-bundle.json'));
      this.updateBundleCallback(bundle);
    });
  }
};
